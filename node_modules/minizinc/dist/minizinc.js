var MiniZinc=function(t){"use strict";const e=encodeURIComponent("4.3.5");let n={workerURL:new URL(`./minizinc-worker.js?version=${e}`,document.currentScript.src),numWorkers:2};const s=[];let r;function o(){if(!r){const t=`importScripts(${JSON.stringify(n.workerURL)});`;r=URL.createObjectURL(new Blob([t],{type:"text/javascript"}))}const t=new Worker(r);t.postMessage({wasmURL:n.wasmURL?n.wasmURL.toString():new URL(`./minizinc.wasm?version=${e}`,n.workerURL).toString(),dataURL:n.dataURL?n.dataURL.toString():new URL(`./minizinc.data?version=${e}`,n.workerURL).toString()}),s.push({worker:t,runCount:0})}function i(){for(;s.length<n.numWorkers;)o()}class a{constructor(){this.vfs={},this._toRun=[],this.unnamedCount=0}clone(){const t=new a;return t.vfs={...this.vfs},t._toRun=[...this.toRun],t.unnamedCount=this.unnamedCount,t}addString(t){let e=`_mzn_${this.unnamedCount++}.mzn`;for(;e in this.vfs;)e=`_mzn_${this.unnamedCount++}.mzn`;return this.addFile(e,t),e}addDznString(t){let e=`_dzn_${this.unnamedCount++}.dzn`;for(;e in this.vfs;)e=`_dzn_${this.unnamedCount++}.dzn`;return this.addFile(e,t),e}addJson(t){let e=`_json_${this.unnamedCount++}.json`;for(;e in this.vfs;)e=`_json_${this.unnamedCount++}.json`;return this.addFile(e,JSON.stringify(t)),e}addFile(t,e,n=!0){if("string"!=typeof e){if(t in this.vfs)return void this._addToRun(t,n);throw new Error("Missing file contents argument")}this.vfs[t]=e,this._addToRun(t,n)}_addToRun(t,e){e&&(t.endsWith(".mzn")||t.endsWith(".mzc")||t.endsWith(".dzn")||t.endsWith(".json")||t.endsWith(".mpc")||t.endsWith(".fzn"))&&-1===this._toRun.indexOf(t)&&this._toRun.push(t)}_run(t,e,n=null){i();const r=[];let o=this.vfs;if(e){let t=`_mzn_${this.unnamedCount++}.mpc`;for(;t in this.vfs;)t=`_mzn_${this.unnamedCount++}.mpc`;o={...this.vfs,[t]:JSON.stringify(e)},r.push(t)}let{worker:a,runCount:u}=s.pop();return a.postMessage({jsonStream:!0,files:o,args:[...r,...t,...this._toRun],outputFiles:n}),{worker:a,runCount:u+1}}check(t){return new Promise(((e,n)=>{const r={...t},{worker:i,runCount:a}=this._run(["--model-check-only"],r.options),u=[];i.onmessage=t=>{switch(t.data.type){case"error":u.push(t.data);break;case"exit":a<10?s.push({worker:i,runCount:a}):(i.terminate(),o()),e(u)}}}))}interface(t){return new Promise(((e,n)=>{const r={...t},{worker:i,runCount:a}=this._run(["-c","--model-interface-only"],r.options),u=[];let d=null;i.onmessage=t=>{switch(t.data.type){case"error":u.push(t.data);break;case"interface":d=t.data;break;case"exit":a<10?s.push({worker:i,runCount:a}):(i.terminate(),o()),0===t.data.code?e(d):n(u)}}}))}compile(t){const e={...t};let n=0,s=`_fzn_${n++}.fzn`;for(;s in this.vfs;)s=`_fzn_${n++}.fzn`;const r=["-c","--fzn",s],{worker:i}=this._run(r,e.options,[s]);o();let a={},u=!1,d=null;return i.onmessage=t=>{if(a[t.data.type])for(const e of a[t.data.type])e(t.data);switch(t.data.type){case"exit":i.terminate(),u=!0,a={};break;case"error":d||(d=t.data)}},{isRunning:()=>!u,cancel(){if(!u){if(u=!0,i.terminate(),a.exit)for(const t of a.exit)t({type:"exit",code:null});a={}}},on(t,e){a[t]?a[t].add(e):a[t]=new Set([e])},off(t,e){a[t]&&a[t].delete(e)},then(t,e){const n=n=>{if(0===n.code)t(n.outputFiles[s]);else{const t=d?{message:d.message,...n}:n;if(!e)throw t;e(t)}};a.exit?a.exit.add(n):a.exit=new Set([n])}}}solve(t){const e={jsonOutput:!0,...t},n=["-i"];e.jsonOutput&&(n.push("--output-mode"),n.push("json"));const{worker:s}=this._run(n,e.options);o();let r=null,i={},a=!1,u=null,d={},c="UNKNOWN";return s.onmessage=t=>{if(i[t.data.type])for(const e of i[t.data.type])e(t.data);switch(t.data.type){case"exit":s.terminate(),a=!0,i={};break;case"error":r||(r=t.data);break;case"statistics":d={...d,...t.data.statistics};break;case"solution":u=t.data,c="SATISFIED";break;case"status":c=t.data.status}},{isRunning:()=>!a,cancel(){if(!a){if(a=!0,s.terminate(),i.exit)for(const t of i.exit)t({type:"exit",code:null});i={}}},on(t,e){i[t]?i[t].add(e):i[t]=new Set([e])},off(t,e){i[t]&&i[t].delete(e)},then(t,e){const n=n=>{if(0===n.code)t({status:c,solution:u,statistics:d});else{const t=r?{message:r.message,...n}:n;if(!e)throw t;e(t)}};i.exit?i.exit.add(n):i.exit=new Set([n])}}}}return t.Model=a,t.init=async function(t){if(t&&(n={...n,...t}),s.length>0)throw new Error("MiniZinc.init() called after library already used/initialised");i(),await Promise.race(s.map((t=>new Promise((e=>{t.worker.addEventListener("message",(t=>{"ready"===t.data.type&&e()}),{once:!0})})))))},t.readStdlibFileContents=function(t){const e=Array.isArray(t)?t:[t];return new Promise(((n,r)=>{i();let{worker:a,runCount:u}=s.pop();a.postMessage({readStdlibFiles:e}),a.onmessage=e=>{"readStdlibFiles"===e.data.type?(u<10?s.push({worker:a,runCount:u+1}):(a.terminate(),o()),Array.isArray(t)?n(e.data.files):n(e.data.files[t])):"error"===e.data.type&&(a.terminate(),o(),r(e.data.message))}}))},t.shutdown=function(){for(const t of s)t.worker.terminate();s.splice(0),URL.revokeObjectURL(r),r=null},t.solvers=function(){return new Promise(((t,e)=>{i();let{worker:n,runCount:r}=s.pop();n.postMessage({jsonStream:!1,args:["--solvers-json"]}),n.onmessage=i=>{"exit"===i.data.type&&(r<10?s.push({worker:n,runCount:r+1}):(n.terminate(),o()),0===i.data.code?t(JSON.parse(i.data.stdout)):e(i.data))}}))},t.version=function(){return new Promise(((t,e)=>{i();let{worker:n,runCount:r}=s.pop();n.postMessage({jsonStream:!1,args:["--version"]}),n.onmessage=i=>{"exit"===i.data.type&&(r<10?s.push({worker:n,runCount:r+1}):(n.terminate(),o()),0===i.data.code?t(i.data.stdout):e(i.data))}}))},t}({});
